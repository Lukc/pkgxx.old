#!/usr/bin/env bash

REVISION="`git rev-list --all 2>/dev/null | wc -l | sed -e 's| *||g'`"
VERSION="0.9-devel-$REVISION"

arch () {
	arch="$(uname -m)"
	case ${arch} in
		alpha|ia64|m68k|ppc|ppc64|x86_64|loongson) ;;
		# loongson is the arch of Loongson (MIPS64el) processors on
		#+ OpenBSD.
		arm*) arch=arm ;;
		i?86) arch=x86 ;;
		mips*) arch=mips ;;
		parisc*) arch=hppa ;;
		"Power Macintosh") arch=ppc ;;
		s390*) arch=s390 ;;
		sh*) arch=sh ;;
		sparc*) arch=sparc ;;
		*)
			echo "Nobody tested your architecture. Pease use --arch=<your arch> to set it manually. The default value would be $(uname -s)." >&2
			echo "The only known values are, for now, alpha, ia64, m68k, ppc, ppc64, x86, x86_64, arm, mips, hppa, s390, sh and sparc." >&2
		;;
	esac
	if has $PACKAGE_MANAGER pacman{,-g2} rpm nhopkg; then
		case ${arch} in
			x86) arch=i686;;
		esac
	elif [[ $PACKAGE_MANAGER = dpkg ]]; then
		case ${arch} in
			x86) arch=i386;;
			x86_64) arch=amd64;;
			arm) arch=armel;;
		esac
	fi
	echo ${arch}
}

kernel () {
	kernel="$(uname -s)"
	case ${kernel} in
		Linux|FreeBSD|OpenBSD|NetBSD) ;;
		CYGWIN*) kernel=Cygwin ;;
		*)
			echo "Nobody tested your kernel. Please, use --kernel=<your kernel> to set it manually. The default value would be $(uname -s)." >&2
			echo "The only known values are, for now, Linux, OpenBSD, NetBSD and FreeBSD." >&2
			exit 1
		;;
	esac
	echo ${kernel}
}

package_manager () {
	pm=
	if checking_for_bin "dpkg" &> /dev/null; then
		: ${pm:=dpkg}
	elif checking_for_bin "rpm" &> /dev/null; then
		: ${pm:=rpm}
	elif checking_for_bin "pacman-g2" &> /dev/null; then
		: ${pm:=pacman-g2}
	elif checking_for_bin "pacman" &> /dev/null; then
		: ${pm:=pacman}
	elif checking_for_bin "nhopkg" &> /dev/null; then
		: ${pm:=nhopkg}
	elif checking_for_bin "installpkg" &> /dev/null \
		&& checking_for_bin "updatepkg" \
		&& checking_for_bin "makepkg";
	then
		: ${pm:=pkgtools}
	elif checking_for_bin "pkgadd" &> /dev/null \
		&& checking_for_bin "pkginfo" &> /dev/null \
		&& checking_for_bin "pkgrm" &> /dev/null;
	then
		: ${pm:=pkgutils}
	else
		: ${pm="Unknown"}
	fi
	echo ${pm}
}

distribution () {
	if grep -q CRUX /etc/issue &>/dev/null; then
		: ${DISTRIBUTION:="Crux"}
	elif [[ -e /etc/frugalware-release ]]; then
		: ${DISTRIBUTION:="Frugalware"}
	elif [[ -e /etc/mandriva-release ]]; then
		: ${DISTRIBUTION:="Mandriva"}
	elif [[ -e /etc/arch-release ]]; then
		: ${DISTRIBUTION:="Arch"}
	elif [[ $PACKAGE_MANAGER = pkgtools ]]; then
		: ${DISTRIBUTION:="Slackware"}
	elif [[ $PACKAGE_MANAGER = dpkg ]] && checking_for_bin "apt-get" &> /dev/null;
	then
		: ${DISTRIBUTION:="Debian"}
	elif [[ "$KERNEL" = FreeBSD ]]; then
		: ${DISTRIBUTION:="FreeBSD"}
	else
		: ${DISTRIBUTION:="Unknown"}
	fi
	echo $DISTRIBUTION
}

checking_for () {
	echo -n "Checking for $1... "
}

checking_for_bin () {
	checking_for $1
	for i in `echo "$PATH" | sed "s|:| |g"`; do
		if [[ -x $i/$1 ]]; then
			echo "yes"
			return 0
		fi
	done
	echo "no"
	return 1
}

has () {
	local flag="$1"
	shift 1
	for i in $@; do
		if [[ "$flag" = "$i" ]]; then
			return 0
		fi
	done
	return 1
}

print_help () {
	echo "\`configure' configures pkg++ $VERSION to adapt to many kinds of systems."
	echo 
	echo "Usage: ./configure [OPTION]..."
	echo 
	echo "Defaults for the options are specified in brackets."
	echo 
	echo "Configuration:"
	echo "  -h, --help              display this help and exit"
	echo "  -V, --version           display version information and exit"
	echo 
	echo "Installation directories:"
	echo "  --prefix=PREFIX         install architecture-independent files in PREFIX"
	echo "                          [/usr]"
	echo "  --exec-prefix=EPREFIX   install architecture-dependent files in EPREFIX"
	echo "                          [PREFIX]"
	echo 
	echo "Optional Features:"
	echo "  --without-curl             Disable cURL support."
	echo "  --without-wget             Disable wget support. [UNRECOMMENDED]"
	echo "  --with-dpkg                Disable pkgutils support and add dpkg support. [UNCOMPLETE]"
	echo "  --with-bsdtar              Use bsdtar instead of GNU tar for compression/decompression."
	echo "  --with-gtar                Use GNU tar instead of bsdtar for compression/decompression."
	echo "  --without-gsed             Use non-GNU sed. Slower but usable on non-GNU userlands."
	echo "  --without-gfind            Use non-GNU find. Slower but usable on non-GNU userlands."
	echo 
	echo "Fine tuning of the installation directories:"
	echo "  --sharedir=DIR             read-only architecture-independent data [PREFIX/share]"
	echo "  --mandir=DIR               man documentation [SHAREDIR/man]"
	echo "  --sysconfdir=DIR           read-only single-machine data [/etc]"
	echo 
	echo "System Informations:"
	echo "  --package-manager=         Choose the package manager to use behind pkg++."
	echo "  --distribution=            Set the distribution's name."
	echo "  --arch=                    Set the architecture's name."
	echo "  --kernel=                  Set the kernel's name."
	echo 
	echo "By default, \`make install' will install all the files in"
	echo "\`/usr/bin', \`/usr/lib' etc.  You can specify"
	echo "an installation prefix other than \`/usr' using \`--prefix',"
	echo "for instance \`--prefix=$HOME'."

}

USE_CURL=
USE_GSED=
USE_GFIND=
USE_BSDTAR=
USE_GTAR=
GTAR_NAME=
GMAKE_PATH=

for arg in $@; do
	case $arg in
		-h|--help)
			print_help
			exit 0
		;;
		-V|--version)
			echo "pkg++ $VERSION"
			exit 0
		;;
		--with-*)
			with="`echo "$arg" | sed "s|--with-||"`"
			case $with in
				curl)
					USE_CURL=true
				;;
				bsdtar|libarchive)
					USE_BSDTAR=true
				;;
				gtar|gnu-tar)
					USE_GTAR=true
				;;
				gsed|gnu-sed)
					USE_GSED=true
				;;
				gfind|gnu-find)
					USE_GFIND=true
				;;
				*)
					echo "Unknown package $with."
					echo "Please make $0 --help for more informations."
				;;
			esac
		;;
		--without-*)
			without="`echo "$arg" | sed "s|--without-||"`"
			case $without in
				curl)
					USE_CURL=false
				;;
				bsdtar|libarchive)
					USE_BSDTAR=false
				;;
				gtar|gnu-tar)
					USE_GTAR=false
				;;
				gsed|gnu-sed)
					USE_GSED=false
				;;
				gfind|gnu-find)
					USE_GFIND=false
				;;
				*)
					echo "Unknown package $without."
					echo "Please make $0 --help for more informations."
				;;
			esac
		;;
		--prefix=*)
			PREFIX="`echo "$arg" | sed "s|--prefix=||"`"
		;;
		--exec-prefix=*)
			EPREFIX="`echo "$arg" | sed "s|--exec-prefix=||"`"
		;;
		--sharedir=*)
			SHAREDIR="`echo "$arg" | sed "s|--sharedir=||"`"
		;;
		--mandir=*)
			MANDIR="`echo "$arg" | sed "s|--mandir=||"`"
		;;
		--sysconfdir=*)
			SYSCONFDIR="`echo "$arg" | sed "s|--sysconfdir=||"`"
		;;
		--libexecdir=*)
			LIBEXECDIR="`echo "$arg" | sed "s|--libexecdir=||"`"
		;;
		--package-manager=*)
			PACKAGE_MANAGER="`echo "$arg" | sed "s|--package-manager=||"`"
		;;
		--arch=*)
			ARCHITECTURE="`echo "$arg" | sed "s|--arch=||"`"
		;;
		--kernel=*)
			KERNEL="`echo "$arg" | sed "s|--kernel=||"`"
		;;
		--distribution=*)
			DISTRIBUTION="`echo "$arg" | sed "s|--distribution=||"`"
		;;
		*)
			echo "Unknown parameter: $arg."
			echo "Please make $0 --help for more informations."
		;;
	esac
done

: ${PREFIX:=/usr}
: ${EPREFIX:=$PREFIX}
: ${SHAREDIR:=$PREFIX/share}
: ${MANDIR:=$SHAREDIR/man}
: ${SYSCONFDIR:=/etc}
: ${LIBEXECDIR:=$EPREFIX/libexec}

: ${PACKAGE_MANAGER:=`package_manager`}
: ${KERNEL:=`kernel`}
: ${ARCHITECTURE:=`arch`}
: ${DISTRIBUTION:=`distribution`}

checking_for "gcc >= 4"
if checking_for_bin gcc &> /dev/null; then
	GCC_VERSION=$(gcc --version | head -n1 | cut -d " " -f 3)
	if (( `echo $GCC_VERSION | cut -d . -f 1` < 4 )); then
		echo "GCC is recommended in version 4 or more." >&2
		echo "You may encounter problems or failures building pkg++ without it." >&2
		echo "It is not, however, a runtime dependency." >&2
	fi
else
	echo "GCC is needed to configure and install pkg++, but not to use it." >&2
	exit 1
fi

checking_for "bash >= 4.1"
if checking_for_bin bash &> /dev/null; then
	BASH_VERSION=$(bash --version | head -n 1 | cut -d ' ' -f 4 | sed 's|(.*||')
	if	(( `echo $BASH_VERSION | cut -d . -f 1` >= 4 )) && \
		(( `echo $BASH_VERSION | cut -d . -f 2` >= 1 ));
	then
		echo "yes"
	else
		echo "Bash is found, but is not up to date. pkg++ will surely work, but it is untested." >&2
	fi
else
	echo "no"
	echo "You will need a recent enough bash version to use pkg++. Without bash, you will not be able to install or use pkg++." >&2
	echo "However, pkg++ will surely work with older versions of bash, it is just untested." >&2
fi

checking_for "GNU tar"
if checking_for_bin gtar &> /dev/null; then
	GTAR_NAME="`type -p gtar`"
	: ${USE_GTAR:=true}
	echo "yes"
elif tar --version 2>/dev/null | grep -q "GNU"; then
	GTAR_NAME="`type -p tar`"
	: ${USE_GTAR:=true}
	echo "yes"
else
	: ${USE_BSDTAR:=false}
	echo "no"
fi

if checking_for_bin bsdtar; then
	: ${USE_BSDTAR:=true}
else
	if ! $USE_GTAR; then
		USE_BSDTAR=true
		echo "You will need GNU tar or bsdtar to extract files and build packages." >&2
		echo "pkg++ will be configured to use bsdtar." >&2
	else
		: ${USE_BSDTAR:=false}
	fi
fi

if checking_for_bin curl; then
	: ${USE_CURL:=true}
else
	: ${USE_CURL:=false}
fi
if ! checking_for_bin wget && ! $USE_CURL; then
	echo "You will need wget or curl to be able to download files directly with pkg++." >&2
	echo "pkg++ will be configured to use wget." >&2
fi

checking_for "GNU sed"
if sed --version 2> /dev/null | grep -q "GNU" &> /dev/null; then
	: ${USE_GSED:=true}
	echo "yes"
else
	: ${USE_GSED:=false}
	echo "no"
fi

checking_for "GNU find"
if find --version 2> /dev/null | grep -q "GNU" &> /dev/null; then
	: ${USE_GFIND:=true}
	echo "yes"
else
	: ${USE_GFIND:=false}
	echo "no"
fi

checking_for "GNU Make"
CONTINUE=true
for i in `echo "$PATH" | sed "s|:| |g"`; do
	if [[ -x $i/make ]]; then
		if $i/make --version 2> /dev/null | grep -q "GNU Make"; then
			GMAKE_PATH="$i/make"
		fi
	elif [[ -x $i/gmake ]]; then
		if $i/gmake --version 2> /dev/null | grep -q "GNU Make"; then
			GMAKE_PATH="$i/gmake"
		fi
	fi
done
if [[ -n "$GMAKE_PATH" ]]; then
	echo "yes"
else
	echo "no"
	echo "You need GNU Make to build most packages." >&2
	echo "pkg++ can not be built if GNU Make is not present.." >&2
	echo "If GNU Make is installed but not found, try to add it's path in \$PATH. The 
\$PATH variable just need to be temporary adapted." >&2
	exit 1
fi

checking_for "pkgtools"
if checking_for_bin "installpkg" &> /dev/null && checking_for_pin "removepkg" &> /dev/null; then
	echo "yes"
	: ${PACKAGE_MANAGER:=pkgtools}
else
	echo "no"
	if [[ $PACKAGE_MANAGER = pkgtools ]]; then
		echo "You will need the pkgtools to install you packages." >&2
	fi
fi

if checking_for_bin "dpkg"; then
	: ${PACKAGE_MANAGER:=dpkg}
else
	if [[ $PACKAGE_MANAGER = dpkg ]]; then
		echo "You will need dpkg to build Debian packages." >&2
	fi
fi

if checking_for_bin "rpm"; then
	: ${PACKAGE_MANAGER:=rpm}
else
	if [[ $PACKAGE_MANAGER = rpm ]]; then
		echo "You will need RPM to build and install RPM packages." >&2
	fi
fi

if checking_for_bin "pacman"; then
	: ${PACKAGE_MANAGER:=pacman}
else
	if [[ $PACKAGE_MANAGER = pacman ]]; then
		echo "You will need pacman to install your packages." >&2
	fi
fi
if checking_for_bin "pacman-g2"; then
	: ${PACKAGE_MANAGER:=pacman-g2}
else
	if [[ $PACKAGE_MANAGER = pacman-g2 ]]; then
		echo "You will need pacman-g2 to install fpm packages." >&2
	fi
fi

if ! has $PACKAGE_MANAGER {d,o}pkg rpm pkgtools pkgutils pacman{,-g2} nhopkg; then
	cat << EOF >&2
Your package manager is not known. If you want pkg++ to be built for a 
particular package manager, use the --package-manager=<your-package-manager> 
flag to the configure script.
EOF
	exit 1
fi

echo "Summary:"
echo "  Architecture:           $ARCHITECTURE"
echo "  Kernel:                 $KERNEL"
echo "  Distribution:           $DISTRIBUTION"
echo "  Package manager:        $PACKAGE_MANAGER"

case $ARCHITECTURE in
	x86)		CC_MARCH=i686		;;
	x86_64|amd64)	CC_MARCH=x86-64		;;
	*)		CC_MARCH=$ARCHITECTURE	;;
esac

CPPFLAGS="$CPPFLAGS -x c -E -P -D_VERSION=\"$VERSION\""
CPPFLAGS="$CPPFLAGS -D_ARCH=\"$ARCHITECTURE\" -D_KERNEL=\"$KERNEL\" $CPPFLAGS"
CPPFLAGS="$CPPFLAGS -D_DISTRIBUTION=\"$DISTRIBUTION\" -D_PACKAGE_MANAGER=\"$PACKAGE_MANAGER\""
CPPFLAGS="$CPPFLAGS -D_SHAREDIR=\\\"$SHAREDIR\\\" -D_SYSCONFDIR=\\\"$SYSCONFDIR\\\""
CPPFLAGS="$CPPFLAGS -D_LIBEXECDIR=\\\"$LIBEXECDIR\\\""
CPPFLAGS="$CPPFLAGS -DGMAKE=\"$GMAKE_PATH\""

case $DISTRIBUTION in
	Debian)		CPPFLAGS="$CPPFLAGS -Ddebian=debian"		;;
	Frugalware)	CPPFLAGS="$CPPFLAGS -Dfrugalware=frugalware"	;;
	Crux)		CPPFLAGS="$CPPFLAGS -Dcrux=crux"		;;
	Mandriva)	CPPFLAGS="$CPPFLAGS -Dmandriva=mandriva"	;;
	Arch)		CPPFLAGS="$CPPFLAGS -Darch=arch"		;;
	Slackware)	CPPFLAGS="$CPPFLAGS -Dslackware=slackware"	;;
esac

case $PACKAGE_MANAGER in
	pacman-g2)
		CPPFLAGS="$CPPFLAGS -Dpacman=pacman -Dpacmang2=pacman-g2"
	;;
	*)
		CPPFLAGS="$CPPFLAGS -D$PACKAGE_MANAGER=$PACKAGE_MANAGER"
	;;
esac

if $USE_CURL; then
	CPPFLAGS="$CPPFLAGS -Dcurl=curl"
fi
if $USE_GSED; then
	CPPFLAGS="$CPPFLAGS -Dgsed=sed"
fi
if $USE_GFIND; then
	CPPFLAGS="$CPPFLAGS -Dgfind=find"
fi
if $USE_GTAR && [[ -n "$GTAR_NAME" ]] && ! $USE_BSDTAR; then
	CPPFLAGS="$CPPFLAGS -Dgtar=$GTAR_NAME"
else
	CPPFLAGS="$CPPFLAGS -Dbsdtar=bsdtar"
fi

configure() {
	sed -e "s|@ARCH@|$ARCHITECTURE|"\
		-e "s|@KERNEL@|$KERNEL|"\
		-e "s|@VERSION@|$VERSION|"\
		-e "s|@DISTRIBUTION@|$DISTRIBUTION|"\
		-e "s|@PACKAGE_MANAGER@|$PACKAGE_MANAGER|"\
		-e "s|@MARCH@|$CC_MARCH|"\
		-e "s|@GMAKE@|$GMAKE_PATH|"\
		-e "s|@PREFIX@|$PREFIX|"\
		-e "s|@SHAREDIR@|$SHAREDIR|"\
		-e "s|@SYSCONFDIR@|$SYSCONFDIR|"\
		 $1 > $1.tmp
	mv $1.tmp $1
}

echo "Creation of \`Makefile'..."
DIR () {
	echo "@echo -e \"  \033[34mMKDIR\033[00m        \033[37m$1\033[00m\";[ -d \$(DESTDIR)/$1 ] || mkdir -p \$(DESTDIR)/$1"
}
INSTALL () {
	echo "@echo -e \"  \033[32mINSTALL\033[00m      \033[37m$2\033[00m -> \033[37m$3/$2\033[00m\";install -m$1 $2 \$(DESTDIR)/$3/$(basename $2)"
}
INSTALL_F () {
	echo "@echo -e \"  \033[32mINSTALL\033[00m      \033[37m$2\033[00m -> \033[37m$4/$3\033[00m\";install -m$1 $2 \$(DESTDIR)/$4/$3"
}
REMOVE () {
	echo "@echo -e \"  \033[33mREMOVE\033[00m       \033[37m$1\033[00m\";[ -e $1 ] && rm -rf $1 || true"
}
RULE () {
	echo "@echo -e \"  \033[37m$1\033[00m  \t $2\""
}
cat > Makefile << EOF
# Begin of Makefile

DESTDIR = 
BINDIR = $EPREFIX/bin
SHAREDIR = $SHAREDIR
LIBEXECDIR = $LIBEXECDIR
ETCDIR = $SYSCONFDIR
MANDIR = $MANDIR

PKGXX_VERSION=$VERSION

build: pkgxx

help:
	@echo "The available rules for this Makefile are:"
	`RULE "config   " "Install the configuration files of pkg++."`
	`RULE "man      " "Install the manual pages of pkg++."`
	`RULE "pkgxx    " "Install pkgxx, it's include files and the defaults file."`
	`RULE "update   " "Make the man and pkgxx rules."`
	`RULE "install  " "Nake the man, pkgxx and config rules."`
	`RULE "clean    " "Remove configured files."`

defaults/prefixes:
	cpp $CPPFLAGS "defaults/prefixes.in" >> "defaults/prefixes"

defaults/distributions:
	cpp $CPPFLAGS "defaults/distributions.in" >> "defaults/distributions"

defaults/cross:
	cpp $CPPFLAGS "defaults/cross.in" >> "defaults/cross"

pkgxx: defaults/prefixes defaults/distributions defaults/cross
	cpp $CPPFLAGS "src/main.sh.c" > "pkg++.tmp"
	echo "#!/usr/bin/env bash" > pkg++
	cat pkg++.tmp >> pkg++

config-install:
	`DIR \$\(ETCDIR\)`
	`INSTALL 0644 pkg++.conf \$\(ETCDIR\)`

man-install:
	`DIR \$\(MANDIR\)`
	`DIR \$\(MANDIR\)/man8`
	`DIR \$\(MANDIR\)/man5`
	`INSTALL_F 0644 man/pkg++.8 pkg++.8 \$\(MANDIR\)/man8`
	`INSTALL_F 0644 man/pkg++.conf.5 pkg++.conf.5 \$\(MANDIR\)/man5`
	`INSTALL_F 0644 man/pkgfile.5 pkgfile.5 \$\(MANDIR\)/man5`

pkgxx-install: pkgxx
	`DIR \$\(BINDIR\)`
	`DIR \$\(SHAREDIR\)/pkg++/includes`
	`DIR \$\(SHAREDIR\)/pkg++/defaults`
	`DIR \$\(ETCDIR\)/pkg++/defaults`
	`DIR \$\(ETCDIR\)/pkg++/uses`
	`DIR \$\(LIBEXECDIR\)/pkg++`
	`INSTALL 0755 pkg++ \$\(BINDIR\)`
	`for include in $(ls includes/); do
		INSTALL 0644 includes/$include \$\(SHAREDIR\)/pkg++
		echo -ne "\t"
	done`
	@mv defaults/prefixes		prefixes
	@mv defaults/distributions	distributions
	@mv defaults/cross		cross
	`INSTALL 0644 prefixes		\$\(ETCDIR\)/pkg++/defaults`
	`INSTALL 0644 distributions	\$\(ETCDIR\)/pkg++/defaults`
	`INSTALL 0644 cross		\$\(ETCDIR\)/pkg++/defaults`
	@rm prefixes
	@rm distributions
	@rm cross
	`INSTALL 0644 uses		\$\(SHAREDIR\)/pkg++`
	`INSTALL 0755 tools/opkgmk.sh	\$\(LIBEXECDIR\)/pkg++/`
	if ! [ -e \$(DESTDIR)\$(BINDIR)/pkgxx ]; then \
		ln -s \$(DESTDIR)\$(BINDIR)/{pkg++,pkgxx}; \
	fi

update: pkgxx-install man-install

install: pkgxx-install config-install man-install

clean:
	`REMOVE pkg++`
	`REMOVE pkg++.tmp`
	`REMOVE pkg++.conf`
	`REMOVE man/pkg++.8`
	`REMOVE man/pkg++.conf.5`
	`REMOVE man/pkgfile.5`
	`REMOVE Makefile`
	`REMOVE defaults/distributions`
	`REMOVE defaults/prefixes`
	`REMOVE defaults/cross`
	`REMOVE src/config.sh.h`

pkgfiles:
	sed -e "s|@VERSION@|\${PKGXX_VERSION}|g" Pkgfile.Crux.in > Pkgfile.Crux
	sed -e "s|@VERSION@|\${PKGXX_VERSION}|g" Pkgfile.Nutritive.in > Pkgfile.Nutritive
	sed -e "s|@VERSION@|\${PKGXX_VERSION}|g" Pkgfile.NuTyX.in > Pkgfile.NuTyX
	sed -e "s|@VERSION@|\${PKGXX_VERSION}|g" Pkgfile.devel.in > Pkgfile.devel

# End of file
EOF

cp "pkg++.conf.in" "pkg++.conf"
cp man/{"pkg++.8.in","pkg++.8"}
cp man/{"pkg++.conf.5.in","pkg++.conf.5"}
cp man/{"pkgfile.5.in","pkgfile.5"}
configure "man/pkg++.8"
configure "man/pkg++.conf.5"
configure "man/pkgfile.5"
configure "pkg++.conf"

echo "Configuration done."

